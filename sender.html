<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Multi TWS Audio - Broadcaster</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <button class="icon-btn back-btn" onclick="goBack()">â¬… Back</button>

  <h1>ğŸ™ï¸ Broadcaster</h1>

  <div class="card">
    <p style="opacity:0.8; margin-bottom: -10px;">System Audio Transmission</p>

    <div style="position: relative; margin: 20px 0;">
      <div class="otp-container" id="otp">------</div>
      <div id="otpTimer" style="font-size: 0.8rem; color: var(--primary); opacity: 0.7; margin-top: -10px;">Code expires
        in 60s</div>
    </div>

    <div style="display: flex; gap: 10px; width: 100%;">
      <button id="startBtn">ğŸš€ Start Broadcasting</button>
      <button id="copyBtn"
        style="width: auto; background: rgba(128,128,128,0.1); color: var(--text-dark); border: 1px solid var(--border-dark);">ğŸ“‹</button>
      <button id="regenBtn"
        style="width: auto; background: rgba(128,128,128,0.1); color: var(--text-dark); border: 1px solid var(--border-dark); display: none;">ğŸ”„</button>
    </div>

    <div class="wave-container" id="wave">
      <!-- Generated via JS -->
    </div>

    <div id="bitrate" style="font-family:monospace; color:var(--primary); font-weight:600; min-height:1.2em;"></div>
    <div id="listenerCount"
      style="font-size: 0.9rem; font-weight: bold; color: var(--primary); opacity: 0.8; margin-top: 5px;">ğŸ‘¥ 0 Listeners
    </div>
    <div id="status">Status: Standby</div>
  </div>

  <!-- Instruction Modal -->
  <style>
    #setupModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }

    .modal-content {
      background: #1a1a1a;
      padding: 30px;
      border-radius: 20px;
      max-width: 400px;
      border: 1px solid var(--primary);
      box-shadow: 0 0 30px var(--primary-glow);
    }

    .modal-content h3 {
      color: var(--primary);
      -webkit-text-fill-color: initial;
      background: none;
      text-align: left;
    }

    .modal-content ol {
      padding-left: 20px;
      line-height: 1.6;
      color: #ccc;
      font-size: 0.95rem;
    }

    .modal-content ol b {
      color: #fff;
    }
  </style>

  <div id="setupModal">
    <div class="modal-content">
      <h3>ğŸ› ï¸ Audio Configuration</h3>
      <p style="color:#aaa; margin-bottom:15px; font-size:0.9rem;">To capture system sound, please enable <b>Stereo
          Mix</b>:</p>
      <ol>
        <li>Right-click ğŸ”Š <b>Volume icon</b> in Taskbar.</li>
        <li>Select <b>Sound Settings</b>.</li>
        <li>Go to <b>All sound devices</b>.</li>
        <li>Under Input, find <b>Stereo Mix</b>.</li>
        <li>Set to <b>Allow</b> and <b>Enable</b>.</li>
      </ol>
      <button onclick="closeModal()" style="margin-top:20px;">I've Enabled It / Proceed</button>
    </div>
  </div>

  <script>
    const { spawn } = require('child_process');
    const path = require('path');
    const WS = require('ws');

    // Theme Logic
    function applyTheme() {
      if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');
      else document.body.classList.remove('light');
    }
    applyTheme();

    const waveContainer = document.getElementById('wave');
    for (let i = 0; i < 15; i++) {
      const bar = document.createElement('div');
      bar.className = 'wave-bar';
      bar.style.animationDelay = `${i * 0.1}s`;
      waveContainer.appendChild(bar);
    }

    function getFFmpegPath() {
      const fs = require('fs');
      const packagedPath = path.join(process.resourcesPath, 'ffmpeg.exe');
      if (fs.existsSync(packagedPath)) return packagedPath;
      try { return require('ffmpeg-static'); } catch (e) { return 'ffmpeg'; }
    }

    const ffmpegPath = getFFmpegPath();
    const AUTH_SERVER = "https://multi-tws-audio-stream.onrender.com";
    const WS_SERVER = "wss://multi-tws-audio-backend.onrender.com";

    const otpEl = document.getElementById("otp");
    const statusEl = document.getElementById("status");
    const bitrateEl = document.getElementById("bitrate");
    const listenerCountEl = document.getElementById("listenerCount");
    const otpTimerEl = document.getElementById("otpTimer");
    const regenBtn = document.getElementById("regenBtn");
    const copyBtn = document.getElementById("copyBtn");

    let ffmpeg, ws;
    let isStreaming = false;
    let timeLeft = 60;
    let timerId = null;

    async function fetchNewOtp() {
      try {
        const res = await fetch(`${AUTH_SERVER}/api/auth/generate`, { method: "POST" });
        const data = await res.json();
        otpEl.innerText = data.code;

        if (ws && ws.readyState === WS.OPEN) {
          ws.send(JSON.stringify({ type: "register_sender", code: data.code }));
        }

        resetTimer();
        return data.code;
      } catch (err) {
        statusEl.innerText = "Status: âŒ OTP Error";
        return null;
      }
    }

    function resetTimer() {
      clearInterval(timerId);
      timeLeft = 60;
      otpTimerEl.innerText = `Code expires in ${timeLeft}s`;
      timerId = setInterval(() => {
        timeLeft--;
        otpTimerEl.innerText = `Code expires in ${timeLeft}s`;
        if (timeLeft <= 0) {
          fetchNewOtp();
        }
      }, 1000);
    }

    async function startBroadcasting() {
      if (isStreaming) return;
      isStreaming = true;
      statusEl.innerText = "Status: Initializing...";
      regenBtn.style.display = "block";

      const code = await fetchNewOtp();
      if (!code) { isStreaming = false; return; }

      ws = new WS(WS_SERVER);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        statusEl.innerText = "Status: ğŸ“¡ Live Transmitting";
        waveContainer.classList.add('animating');
        ws.send(JSON.stringify({ type: "register_sender", code }));

        if (!ffmpeg) {
          ffmpeg = spawn(ffmpegPath, [
            "-f", "dshow", "-i", "audio=Stereo Mix (Realtek(R) Audio)",
            "-ac", "1", "-ar", "44100", "-c:a", "aac", "-b:a", "128k", "-f", "adts", "-"
          ]);

          ffmpeg.stdout.on("data", chunk => {
            if (ws.readyState === WS.OPEN) ws.send(chunk);
            const kbps = (110 + Math.random() * 20).toFixed(1);
            bitrateEl.innerText = `${kbps} kbps`;
          });

          ffmpeg.stderr.on("data", d => console.log("FFmpeg Output:", d.toString()));
        }
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === "count") {
            listenerCountEl.innerText = `ğŸ‘¥ ${msg.value} Listeners`;
          }
        } catch (e) { }
      };

      ws.onclose = () => {
        statusEl.innerText = "Status: âŒ Disconnected";
        isStreaming = false;
        clearInterval(timerId);
        waveContainer.classList.remove('animating');
        if (ffmpeg) { ffmpeg.kill(); ffmpeg = null; }
        regenBtn.style.display = "none";
        listenerCountEl.innerText = "ğŸ‘¥ 0 Listeners";
      };

      ws.onerror = (e) => {
        console.error(e);
        statusEl.innerText = "Status: âŒ Connection Error";
      };
    }

    document.getElementById("startBtn").onclick = startBroadcasting;
    regenBtn.onclick = fetchNewOtp;

    copyBtn.onclick = () => {
      navigator.clipboard.writeText(otpEl.innerText);
      const originalText = copyBtn.innerText;
      copyBtn.innerText = "âœ…";
      setTimeout(() => copyBtn.innerText = originalText, 1500);
    };

    function closeModal() { document.getElementById("setupModal").style.display = "none"; }
    function goBack() { require('electron').ipcRenderer.send('go-back'); }
  </script>
</body>

</html>
